name: Publish
on:
  workflow_run:
    workflows: [CI]
    branches: [main]
    types: [completed]

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
        - name: Check out code
          uses: actions/checkout@v4
  
        - uses: pnpm/action-setup@v3
          with:
            version: 9
  
        - name: Setup Node.js environment
          uses: actions/setup-node@v4
          with:
            node-version: 22
            cache: "pnpm"
  
        - name: Install
          run: pnpm install --frozen-lockfile
  
        - name: Release
          id: changesets
          uses: changesets/action@v1
          with:
            publish: pnpm publish-packages
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            NPM_TOKEN: ${{ secrets.NPM_TOKEN }}